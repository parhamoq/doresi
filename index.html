<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>سایت تکالیف دوره سی</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Favicon -->
  <link rel="icon" href="icon.png" type="image/png">
  <!-- Vazirmatn Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <style>
    /* CSS Styles remain the same */
    :root {
      --neon-yellow: #FFD525;
      --neon-green: #39ff14;
      --neon-orange: #ff9900;
      --neon-cyan: #00e5ff;
      --neon-red: #ff4d4d;
      --glass-blur: 8px;
      --class-block-height-reduction: 0rem; /* این مقدار از ارتفاع عمودی دکمه‌های کلاس کم می‌کند */
    }
    body[data-theme='dark'] {
      --bg-gradient: linear-gradient(180deg, #041223 0%, #071a38 55%, #05203a 100%);
      background-attachment: fixed;
      background-repeat: no-repeat;
      --surface: rgba(10, 16, 25, 0.7);
      --muted: #9aa4b2;
      --text: #e6eef8;
      --card: rgba(255, 255, 255, 0.02);
      --border-color: rgba(255, 255, 255, 0.08);
      --particle: rgba(255, 255, 255, 0.06);
      --block-bg: #161b22;  
      --exam-pin-bg: rgba(255, 77, 77, 0.1);
      --exam-pin-border: rgba(255, 77, 77, 0.3);
      color-scheme: dark;
    }
    body[data-theme='light'] {
      --bg-gradient: linear-gradient(180deg, #f7f9fb, #eef2f6);
      --surface: rgba(255, 255, 255, 0.8);
      --muted: #556074;
      --text: #0f1720;
      --card: rgba(2, 6, 23, 0.02);
      --border-color: rgba(2, 6, 23, 0.1);
      --particle: rgba(10, 20, 30, 0.06);
      --block-bg: #ffffff;
      --exam-pin-bg: rgba(255, 77, 77, 0.05);
      --exam-pin-border: rgba(255, 77, 77, 0.2);
      color-scheme: light;
    }
    html, body { height: 100%; }
    body {
      font-family: 'Vazirmatn', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: var(--bg-gradient);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background 240ms ease, color 240ms ease;
    }
    @media (min-width: 1024px) {
        body {
            overflow: hidden;
        }
    }
    @media (max-width: 1023px) {
        body {
            overflow: auto;
        }
    }
    .bg-ambient { position: fixed; inset: 0; pointer-events: none; z-index: 0; mix-blend-mode: overlay; }
    .site-header {
      backdrop-filter: blur(var(--glass-blur));
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border-color);
      transition: background 220ms ease, border-color 220ms ease;
    }
    body[data-theme='light'] .site-header { background: rgba(255, 255, 255, 0.7); }
    .class-block {
      border-radius: 1.5rem;
      border: 1px solid var(--border-color);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      padding: calc(2rem - var(--class-block-height-reduction, 0rem)) 2rem; /* استفاده از متغیر برای کاهش ارتفاع */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: transform 320ms cubic-bezier(.2, .9, .2, 1), box-shadow 320ms ease, border-color 220ms ease;
      cursor: pointer;
      user-select: none;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 25px 4px rgba(var(--glow-rgb), 0.35);
    }
    body[data-theme='light'] .class-block {
      background: linear-gradient(180deg, #fff, #fbfdff);
      box-shadow: 0 0 25px 4px rgba(var(--glow-rgb), 0.25);
    }
    .class-block:focus { outline: 3px solid rgba(0, 0, 0, 0.06); outline-offset: 3px; }
    .class-block:hover {
      transform: translateY(-10px) scale(1.03);
      box-shadow: 0 0 40px 10px rgba(var(--glow-rgb), 0.55);
    }
    body[data-theme='light'] .class-block:hover { box-shadow: 0 0 40px 10px rgba(var(--glow-rgb), 0.45); }
    .neon-label {
      font-weight: 900;
      font-size: clamp(2rem, 8vw, 3.5rem);
      letter-spacing: 0.01em;
      transition: transform 0.4s ease;
    }
    .modal-overlay {
        position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
        padding: 1.25rem; z-index: 90; /* Increased z-index */
        background-color: rgba(0, 0, 0, 0.7); 
        backdrop-filter: blur(5px);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-overlay.visible { opacity: 1; visibility: visible; }
    .modal-card {
        width: 100%; max-width: 420px; border-radius: 12px; padding: 2rem;
        background-color: var(--block-bg);
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.35);
        border: 1px solid var(--border-color);
        transform: scale(0.95);
        transition: transform 0.3s ease;
    }
    .modal-overlay.visible .modal-card { transform: scale(1); }
    .modal-card input, .modal-card select, .modal-card textarea, .modal-card button {
        background-color: rgba(0,0,0,0.2);
        border-color: var(--border-color) !important;
    }
    body[data-theme='light'] .modal-card input, 
    body[data-theme='light'] .modal-card select, 
    body[data-theme='light'] .modal-card textarea,
    body[data-theme='light'] .modal-card button { background-color: rgba(0,0,0,0.05); }
    .clone-full {
      position: fixed; display: flex;
      flex-direction: column;
      align-items: center; justify-content: flex-start;
      padding: 2rem; z-index: 80;
      overflow-y: auto;
    }
    .clone-full .neon-label { transform: scale(1.5); }
    .clone-full-content {
      transition: opacity 0.3s ease 0.2s;
      text-align: right;
      width: 100%;
      max-width: 800px;
      margin-top: 15vh;
    }
    .content-hidden { opacity: 0; pointer-events: none; transition: opacity 0.4s ease; }
    #particle-container { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
    .particle {
      position: absolute; border-radius: 999px; background: var(--particle);
      opacity: 0; animation: floatUp linear infinite;
    }
    @keyframes floatUp {
      0% { transform: translateY(10vh) scale(0.85); opacity: 0; }
      20% { opacity: 0.6; }
      100% { transform: translateY(-120vh) scale(1); opacity: 0; }
    }
    #announcements-list {
      max-height: 120px;
      overflow-y: auto;
      padding-left: 1rem;
    }
    #announcements-list::-webkit-scrollbar {
      width: 6px;
    }
    #announcements-list::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    #announcements-list::-webkit-scrollbar-thumb {
      background: var(--muted);
      border-radius: 10px;
    }
    /* New styles for features */
    .new-badge {
        background: linear-gradient(45deg, var(--neon-yellow), var(--neon-orange));
        color: #1a1a1a;
        padding: 2px 8px;
        border-radius: 99px;
        font-size: 0.75rem;
        font-weight: bold;
        margin-left: 8px;
    }
    .edited-label {
        color: var(--muted);
        font-size: 0.75rem;
        margin-right: auto;
    }
    .exam-pin {
      border: 1px solid var(--exam-pin-border);
      background-color: var(--exam-pin-bg);
      animation: pulse-border 2s infinite;
    }
    @keyframes pulse-border {
      0%, 100% { border-color: var(--exam-pin-border); }
      50% { border-color: var(--neon-red); }
    }
    @media (min-width: 750px) { .class-block { min-height: 10rem; } }
    
    #date-popover {
      font-family: 'Vazirmatn';
    }
  </style>
</head>
<body data-theme="dark">
  <div class="bg-ambient" aria-hidden="true"></div>
  <div id="particle-container" aria-hidden="true"></div>

  <!-- Main content wrapper with reduced padding -->
  <div id="main-content" class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 py-4" style="transition: opacity 0.4s ease;">
    
    <!-- Time/Date Header -->
    <div id="time-header-container" class="relative mb-2">
      <button id="time-button" class="site-header w-full text-center p-1 rounded-xl cursor-pointer hover:bg-white/5 transition-colors">
        <span id="clock-display" class="text-lg" style="color: var(--text);">--:--:--</span>
      </button>
      <div id="date-popover" class="hidden absolute top-full mt-2 w-full max-w-xs right-1/2 translate-x-1/2 z-50 p-4 rounded-xl site-header">
        <div id="popover-content" class="text-center">
            <p style="color:var(--muted)">در حال بارگذاری...</p>
        </div>
      </div>
    </div>

    <header class="site-header flex flex-col sm:flex-row items-center justify-between gap-4 mb-8 p-3 rounded-xl">
      <div class="flex items-center gap-4">
        <img src="icon.png" alt="لوگو" class="w-14 h-14 rounded-full object-cover shadow-lg" onerror="this.style.display='none'" />
        <div class="text-right">
          <h1 class="text-2xl md:text-3xl font-extrabold" style="color:var(--text)">به سایت دوره سی خوش آمدید!</h1>
          <p class="text-sm" style="color:var(--muted)">تکالیف تمام کلاس ها اینجا قرار داده میشه</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
          <!-- Online status -->
          <div id="online-status" class="flex items-center gap-2 text-sm" style="color: var(--muted);">
              <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
              <span><span id="online-count">1</span> نفر آنلاین</span>
          </div>
          <div id="auth-buttons" class="flex items-center gap-3">
              <button id="login-button" class="px-4 py-2 rounded-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow hover:scale-105 transition-transform focus:outline-none focus:ring-4 focus:ring-blue-300" aria-haspopup="dialog">ورود</button>
              <button id="add-homework-main-button" class="hidden px-4 py-2 rounded-full bg-gradient-to-r from-green-500 to-emerald-600 text-white shadow hover:scale-105 transition-transform focus:outline-none focus:ring-4 focus:ring-green-300">افزودن تکلیف</button>
              <button id="logout-button" class="hidden px-4 py-2 rounded-full bg-gradient-to-r from-red-500 to-rose-600 text-white shadow hover:scale-105 transition-transform focus:outline-none focus:ring-4 focus:ring-red-300">خروج</button>
              <button id="theme-toggle" class="p-3 rounded-lg bg-white/5 hover:bg-white/10 transition-colors focus:outline-none focus:ring-2 ring-white/20" aria-label="تغییر تم">
              </button>
          </div>
      </div>
    </header>
    <main>
      <section class="mb-8">
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-6" id="class-grid" aria-live="polite">
          <!-- blocks created by JS -->
        </div>
      </section>

      <section id="announcements-section" class="mt-8">
        <h2 class="text-2xl font-bold mb-4 border-b-2 pb-2" style="border-color: var(--border-color);">اعلانات</h2>
        <div id="announcements-list" class="space-y-3">
          <!-- Announcements will be loaded here by JS -->
        </div>
      </section>
    </main>
  </div>
 
  <!-- Support Floating Action Button (Resized) -->
  <button id="support-fab" class="fixed bottom-6 left-6 z-50 w-11 h-11 rounded-full bg-gradient-to-r from-teal-500 to-cyan-600 text-white shadow-lg flex items-center justify-center hover:scale-110 transition-transform focus:outline-none focus:ring-4 focus:ring-cyan-300" aria-label="باز کردن پشتیبانی">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
  </button>


  <!-- Modals -->
  <div id="login-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="login-title">
    <div class="modal-card">
      <div class="flex items-start justify-between mb-3">
        <h3 id="login-title" class="text-xl font-bold">ورود به پنل</h3>
        <button id="close-login-modal" class="text-gray-400 hover:text-gray-200 text-2xl" aria-label="بستن">&times;</button>
      </div>
      <div>
        <p id="login-message" class="text-sm mb-3 h-6"></p>
        <label for="name-input" class="block text-sm mb-1">کد نماینده</label>
        <input id="name-input" type="text" class="w-full rounded-md p-3 border focus:ring-2 focus:ring-indigo-300" />
        <button id="submit-login" class="mt-4 w-full py-3 bg-gradient-to-r from-indigo-600 to-blue-500 text-white rounded-md hover:opacity-90 transition-opacity">ورود</button>
      </div>
    </div>
  </div>
  <div id="homework-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="homework-title">
      <div class="modal-card">
          <div class="flex items-start justify-between mb-3">
              <h3 id="homework-title" class="text-xl font-bold">افزودن تکلیف جدید</h3>
              <button id="close-homework-modal" class="text-gray-400 hover:text-gray-200 text-2xl" aria-label="بستن">&times;</button>
          </div>
          <div class="space-y-4">
              <input type="hidden" id="homework-id"> <!-- For editing -->
              <div>
                  <label class="block text-sm mb-1">نوع</label>
                  <input type="hidden" id="homework-type" value="homework">
                  <div class="grid grid-cols-2 gap-2">
                      <button id="type-homework-btn" data-type="homework" class="w-full p-2 border rounded-md text-sm transition-colors hover:bg-blue-400/20">تکلیف</button>
                      <button id="type-exam-btn" data-type="exam" class="w-full p-2 border rounded-md text-sm transition-colors hover:bg-red-400/20">امتحان</button>
                  </div>
              </div>
              <div>
                  <label for="class-select" class="block text-sm mb-1">کلاس</label>
                  <select id="class-select" class="w-full rounded-md p-3 border focus:ring-2 focus:ring-indigo-300">
                      <option value="">انتخاب کنید...</option>
                  </select>
              </div>
              <div>
                  <label for="homework-date" class="block text-sm mb-1">تاریخ امروز</label>
                  <input id="homework-date" type="text" placeholder="مثلا: ۱۴۰۴/۰۷/۰۷ " class="w-full rounded-md p-3 border focus:ring-2 focus:ring-indigo-300" />
              </div>
              <div>
                  <label for="homework-due-date" id="due-date-label" class="block text-sm mb-1">مهلت تحویل</label>
                  <input id="homework-due-date" type="text" placeholder="مثلا: تا جلسه آینده فیزیک" class="w-full rounded-md p-3 border focus:ring-2 focus:ring-indigo-300" />
              </div>
              <div>
                  <label for="homework-details" class="block text-sm mb-1">شرح</label>
                  <textarea id="homework-details" rows="4" placeholder="شرح تکلیف یا امتحان..." class="w-full rounded-md p-3 border focus:ring-2 focus:ring-indigo-300"></textarea>
              </div>
              <button id="add-homework-button" class="w-full py-3 bg-gradient-to-r from-green-600 to-emerald-500 text-white rounded-md hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                  ثبت
              </button>
          </div>
      </div>
  </div>
 
  <!-- Support Modal -->
  <div id="support-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="support-title">
      <div class="modal-card">
          <div id="support-form-view">
              <div class="flex items-start justify-between mb-3">
                  <h3 id="support-title" class="text-xl font-bold">پشتیبانی و گزارش باگ</h3>
                  <button id="close-support-modal" class="text-gray-400 hover:text-gray-200 text-2xl" aria-label="بستن">&times;</button>
              </div>
              <p class="text-sm mb-4" style="color: var(--muted);">هرگونه مشکل، باگ یا پیشنهادی دارید، اینجا برامون بنویسید.</p>
              <div class="space-y-4">
                  <div>
                      <label for="support-details" class="sr-only">پیام شما</label>
                      <textarea id="support-details" rows="6" placeholder="پیام شما..." class="w-full rounded-md p-3 border focus:ring-2 focus:ring-cyan-300"></textarea>
                  </div>
                  <button id="submit-support" class="w-full py-3 bg-gradient-to-r from-cyan-600 to-teal-500 text-white rounded-md hover:opacity-90 transition-opacity">ارسال پیام</button>
              </div>
          </div>
          <div id="support-success-view" class="hidden text-center py-8">
              <h3 class="text-2xl font-bold text-green-400 mb-3">پیام شما ارسال شد!</h3>
              <p style="color: var(--muted);">از نظرتون متشکریم. ما به زودی آن را بررسی خواهیم کرد.</p>
          </div>
      </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast-notification" class="fixed top-5 right-1/2 translate-x-1/2 z-[100] px-6 py-3 rounded-lg text-white transition-all duration-300 opacity-0 -translate-y-20">
      <p id="toast-message"></p>
  </div>


  <!-- Import Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
 
  <script type="module">
    // ============================================
    // SUPABASE CONFIGURATION
    // ============================================
    const SUPABASE_URL = 'https://pyvwnbpufpalbvvnuwch.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5dnduYnB1ZnBhbGJ2dm51d2NoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTQ2NTcsImV4cCI6MjA3MTg5MDY1N30.82zlBtvsazt9lQLLBuNtouPKenZPTrBqXc1tEtECSDY';

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      console.error("خطا: اطلاعات اتصال به Supabase را در کد وارد کنید.");
    }

    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================
    // DOM Elements
    // ============================================
    const classGrid = document.getElementById('class-grid');
    const particleContainer = document.getElementById('particle-container');
    const themeToggle = document.getElementById('theme-toggle');
    const mainContent = document.getElementById('main-content');
    const loginButton = document.getElementById('login-button');
    const addHomeworkMainButton = document.getElementById('add-homework-main-button');
    const logoutButton = document.getElementById('logout-button');
    const loginModal = document.getElementById('login-modal');
    const closeLogin = document.getElementById('close-login-modal');
    const submitLogin = document.getElementById('submit-login');
    const nameInput = document.getElementById('name-input');
    const loginMessage = document.getElementById('login-message');
    const homeworkModal = document.getElementById('homework-modal');
    const closeHomeworkModal = document.getElementById('close-homework-modal');
    const classSelect = document.getElementById('class-select');
    const homeworkDate = document.getElementById('homework-date');
    const homeworkDueDate = document.getElementById('homework-due-date');
    const homeworkDetails = document.getElementById('homework-details');
    const addHomeworkButton = document.getElementById('add-homework-button');
    const announcementsList = document.getElementById('announcements-list');
    const homeworkTitle = document.getElementById('homework-title');
    const homeworkIdInput = document.getElementById('homework-id');
    const homeworkTypeInput = document.getElementById('homework-type');
    const typeHomeworkBtn = document.getElementById('type-homework-btn');
    const typeExamBtn = document.getElementById('type-exam-btn');
    const onlineCountSpan = document.getElementById('online-count');
    const dueDateLabel = document.getElementById('due-date-label');
    const supportFab = document.getElementById('support-fab');
    const supportModal = document.getElementById('support-modal');
    const closeSupportModal = document.getElementById('close-support-modal');
    const submitSupport = document.getElementById('submit-support');
    const supportDetails = document.getElementById('support-details');
    const supportFormView = document.getElementById('support-form-view');
    const supportSuccessView = document.getElementById('support-success-view');
    // New Clock/Date elements
    const timeButton = document.getElementById('time-button');
    const clockDisplay = document.getElementById('clock-display');
    const datePopover = document.getElementById('date-popover');
    const popoverContent = document.getElementById('popover-content');

    // ============================================
    // Data & State
    // ============================================
    const classNames = ['9/1', '9/2', '9/3', '9/4', '9/5'];
    const neonColors = [
        { name: 'orange', rgb: '255, 153, 0' },      
        { name: 'green',  rgb: '57, 255, 20' },
        { name: 'purple', rgb: '173, 8, 242' },
        { name: 'cyan',   rgb: '0, 229, 255' },
        { name: 'red',    rgb: '255, 77, 77' }
    ];
    let currentCreator = null;
    let activeClassChannel = null;

    const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>`;
    const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>`;

    // ============================================
    // Time, Date & Countdown Logic (NEW)
    // ============================================
    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, numberingSystem: 'arab' });
        clockDisplay.textContent = timeString;
    }

    async function fetchAndRenderPopoverContent() {
        const now = new Date();
        
        // --- Date Formats ---
        const shamsiDate = new Intl.DateTimeFormat('fa-IR-u-ca-persian', { day: 'numeric', month: 'long', year: 'numeric', numberingSystem: 'arab' }).format(now);
        let qamariDate = new Intl.DateTimeFormat('fa-IR-u-ca-islamic-civil', { day: 'numeric', month: 'long', year: 'numeric', numberingSystem: 'arab' }).format(now);
        qamariDate = qamariDate.replace(' ه‍.ق.', ''); // حذف کردن ه‍.ق.
        const miladiDate = new Intl.DateTimeFormat('fa-IR-u-ca-gregory', { day: 'numeric', month: 'long', year: 'numeric', numberingSystem: 'arab' }).format(now);

        let contentHTML = `
            <div class="space-y-2 text-sm">
                <p><strong>شمسی:</strong> ${shamsiDate}</p>
                <p><strong>قمری:</strong> ${qamariDate}</p>
                <p><strong>میلادی:</strong> ${miladiDate}</p>
            </div>
            <hr class="my-3" style="border-color: var(--border-color);" />
            <div id="countdown-list" class="space-y-2 text-sm">
                <p style="color:var(--muted)">درحال بارگذاری روزشمار...</p>
            </div>
        `;
        popoverContent.innerHTML = contentHTML;

        // --- Countdown ---
        try {
            const { data: events, error } = await db.from('events').select('event_name, event_date').order('event_date', { ascending: true });
            if (error) throw error;
            
            const countdownList = document.getElementById('countdown-list');
            if (events && events.length > 0) {
                let countdownHTML = '';
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize today's date for accurate comparison

                events.forEach(event => {
                    const eventDate = new Date(event.event_date);
                    eventDate.setHours(0, 0, 0, 0); // Normalize event date
                    
                    const diffTime = eventDate - today;
                    if (diffTime >= 0) { // Only show future events
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        const diffDaysPersian = new Intl.NumberFormat('fa-IR').format(diffDays);
                        countdownHTML += `<div class="flex justify-between items-center"><span>${event.event_name}</span><span class="font-bold">${diffDaysPersian} روز</span></div>`;
                    }
                });
                 countdownList.innerHTML = countdownHTML || '<p style="color:var(--muted)">رویداد آینده‌ای ثبت نشده.</p>';
            } else {
                 countdownList.innerHTML = '<p style="color:var(--muted)">رویداد آینده‌ای ثبت نشده.</p>';
            }
        } catch (e) {
            console.error("Error fetching events:", e);
            document.getElementById('countdown-list').innerHTML = `<p class="text-red-400">خطا در بارگذاری روزشمار.</p>`;
        }
    }
    
    // ============================================
    // Theme, Particles, UI Helpers
    // ============================================
    function applyTheme(theme) {
      document.body.dataset.theme = theme;
      themeToggle.innerHTML = theme === 'dark' ? sunIcon : moonIcon;
      localStorage.setItem('theme', theme);
    }
    function createBlocks() {
      classGrid.innerHTML = '';
      const totalItems = classNames.length;
      classNames.forEach((name, i) => {
        const div = document.createElement('button');
        div.className = 'class-block';
        const colorInfo = neonColors[i % neonColors.length];
        div.style.setProperty('--glow-rgb', colorInfo.rgb);
        div.setAttribute('aria-label', `باز کردن کلاس ${name}`);
        div.type = 'button';
        const label = document.createElement('div');
        label.className = 'neon-label';
        label.textContent = name;
        div.appendChild(label);
        if (i < 3) { div.classList.add('md:col-span-2'); } else { div.classList.add('md:col-span-3'); }
        if (totalItems % 2 !== 0 && i === totalItems - 1) { div.classList.add('col-span-2'); }
        div.addEventListener('click', () => openFullscreen(div, name));
        classGrid.appendChild(div);
      });
    }
    function createParticles() {
      particleContainer.innerHTML = '';
      const count = Math.floor(window.innerWidth / 15);
      for (let i = 0; i < count; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        const size = (Math.random() * 2) + 0.6;
        Object.assign(p.style, { width: `${size}px`, height: `${size}px`, left: `${Math.random() * 100}%`, top: `${Math.random() * 100}%`, animationDuration: (18 + Math.random() * 22) + 's', opacity: 0.05 + Math.random() * 0.25 });
        particleContainer.appendChild(p);
      }
    }
    function showModal(modalEl) { modalEl.classList.add('visible'); }
    function hideModal(modalEl) { modalEl.classList.remove('visible'); }
   
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');

        toastMessage.textContent = message;
       
        toast.className = 'fixed top-5 right-1/2 translate-x-1/2 z-[100] px-6 py-3 rounded-lg text-white transition-all duration-300 opacity-0 -translate-y-20';
        if (type === 'success') {
            toast.classList.add('bg-green-500');
        } else {
            toast.classList.add('bg-red-500');
        }
       
        requestAnimationFrame(() => {
            toast.classList.remove('opacity-0', '-translate-y-20');
            toast.classList.add('opacity-100', 'translate-y-0');
        });

        setTimeout(() => {
            toast.classList.remove('opacity-100', 'translate-y-0');
            toast.classList.add('opacity-0', '-translate-y-20');
        }, 3000);
    }

    // ============================================
    // Fullscreen View & Data Rendering
    // ============================================
    let activeClone = null;
    async function openFullscreen(el, name) {
      if (activeClone) return;
     
      mainContent.classList.add('content-hidden');
      const rect = el.getBoundingClientRect();
      const clone = el.cloneNode(true);
      clone.classList.add('clone-full');
      Object.assign(clone.style, { position: 'fixed', top: `${rect.top}px`, left: `${rect.left}px`, width: `${rect.width}px`, height: `${rect.height}px`, margin: '0', transition: 'all 450ms cubic-bezier(0.4, 0, 0.2, 1)', zIndex: 80 });
      const contentDiv = document.createElement('div');
      contentDiv.className = 'clone-full-content';
      contentDiv.id = `content-for-${name.replace('/', '-')}`;
      contentDiv.innerHTML = `<p class="text-center" style="color:var(--muted)">در حال بارگذاری...</p>`;
      clone.appendChild(contentDiv);
      document.body.appendChild(clone);
      activeClone = { node: clone, rect, className: name };

      requestAnimationFrame(async () => {
        Object.assign(clone.style, { top: '0', left: '0', width: '100vw', height: '100vh', borderRadius: '0' });
        contentDiv.style.opacity = '1';
        await renderClassContent(name);

        if(activeClassChannel) {
            db.removeChannel(activeClassChannel);
        }
        activeClassChannel = db.channel(`class-${name.replace('/', '-')}`)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'homeworks', filter: `classname=eq.${name}` }, () => renderClassContent(name))
            .subscribe();

      });
      clone.addEventListener('click', (e) => {
        if(e.target === clone) closeFullscreen();
      });
    }

    async function renderClassContent(name) {
        const contentDiv = document.getElementById(`content-for-${name.replace('/', '-')}`);
        if(!contentDiv) return;

        try {
            const { data: homeworks, error: hwError } = await db
                .from('homeworks')
                .select('*')
                .eq('classname', name)
                .order('is_exam', { ascending: false })
                .order('created_at', { ascending: false });

            if (hwError) throw hwError;
           
            contentDiv.innerHTML = renderHomeworks(homeworks, name);
            addDynamicEventListeners(contentDiv);

        } catch (e) {
            console.error("Error fetching class content: ", e);
            contentDiv.innerHTML = `<p class="text-center text-red-400">خطا در بارگذاری اطلاعات کلاس.</p>`;
        }
    }
   
    function renderHomeworks(data, className) {
        let homeworkHTML = `<h2 class="text-3xl font-bold mb-6 text-center">تکلیف‌های کلاس ${className}</h2>`;
        if (!data || data.length === 0) {
            homeworkHTML += `<p class="text-center" style="color:var(--muted)">هنوز تکلیفی برای این کلاس ثبت نشده است.</p>`;
        } else {
            homeworkHTML += '<div class="space-y-4">';
            data.forEach(hw => {
                const isNew = (new Date() - new Date(hw.created_at)) < 24 * 60 * 60 * 1000;
                const isOwner = currentCreator && currentCreator === hw.creator;
               
                homeworkHTML += `
                    <div class="p-4 rounded-lg border ${hw.is_exam ? 'exam-pin' : ''}" style="background-color: var(--card); border-color: var(--border-color);" data-hw-id="${hw.id}">
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex items-center">
                                <p class="font-bold text-lg">${hw.date}</p>
                                ${isNew ? '<span class="new-badge">جدید ✨</span>' : ''}
                                ${hw.is_exam ? '<span class="ml-2 text-xs font-bold text-red-400">[امتحان]</span>' : ''}
                            </div>
                            <div class="flex items-center gap-2 ${isOwner ? '' : 'hidden'}">
                                <button class="edit-btn p-1.5 rounded-md hover:bg-white/10" aria-label="ویرایش"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                <button class="delete-btn p-1.5 rounded-md hover:bg-white/10" aria-label="حذف"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                            </div>
                        </div>
                        <p class="mt-2 text-sm" style="color: var(--muted);"><strong>${hw.is_exam ? 'تاریخ امتحان' : 'مهلت تحویل'}:</strong> ${hw.due_date_text}</p>
                        <p class="mt-1 whitespace-pre-wrap">${hw.homework}</p>
                        <div class="flex justify-end mt-2">
                            ${hw.is_edited ? '<span class="edited-label">ویرایش شده</span>' : ''}
                        </div>
                    </div>
                `;
            });
            homeworkHTML += '</div>';
        }
        return homeworkHTML;
    }

    function closeFullscreen() {
      if (!activeClone) return;
      if (activeClassChannel) {
          db.removeChannel(activeClassChannel);
          activeClassChannel = null;
      }
      const { node, rect } = activeClone;
      node.querySelector('.clone-full-content').style.opacity = '0';
      setTimeout(() => {
        Object.assign(node.style, { top: `${rect.top}px`, left: `${rect.left}px`, width: `${rect.width}px`, height: `${rect.height}px`, borderRadius: '1.5rem' });
        mainContent.classList.remove('content-hidden');
      }, 150);
      setTimeout(() => { node.remove(); activeClone = null; }, 600);
    }

    // ============================================
    // Event Listeners & Handlers
    // ============================================
    function addDynamicEventListeners(container) {
        container.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const id = e.currentTarget.closest('[data-hw-id]').dataset.hwId;
                handleEdit(id);
            });
        });
        container.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const id = e.currentTarget.closest('[data-hw-id]').dataset.hwId;
                handleDelete(id);
            });
        });
    }

    async function handleEdit(id) {
        const { data, error } = await db.from('homeworks').select('*').eq('id', id).single();
        if (error || !data || data.creator !== currentCreator) return;
       
        homeworkIdInput.value = data.id;
        classSelect.value = data.classname;
        homeworkDate.value = data.date;
        homeworkDueDate.value = data.due_date_text;
        homeworkDetails.value = data.homework;
        homeworkTypeInput.value = data.is_exam ? 'exam' : 'homework';
        updateTypeButtons();
        homeworkTitle.textContent = 'ویرایش تکلیف';
        addHomeworkButton.textContent = 'ذخیره تغییرات';
        validateHomeworkForm();
        showModal(homeworkModal);
    }
   
    async function handleDelete(id) {
        const { data: recordToDelete, error: selectError } = await db.from('homeworks').select('*').eq('id', id).single();
        if (selectError || !recordToDelete || recordToDelete.creator !== currentCreator) return;

        const { error: insertError } = await db.from('deleted_homeworks').insert([{ ...recordToDelete, deleted_by: currentCreator, deleted_at: new Date().toISOString() }]);
        if (insertError) { 
            console.error("Error moving to deleted_homeworks:", insertError);
            showToast('خطا در آرشیو کردن تکلیف.', 'error');
            return; 
        }

        const { error: deleteError } = await db.from('homeworks').delete().eq('id', id);
        if (deleteError) { 
            console.error("Error deleting from homeworks:", deleteError);
            showToast('خطا در حذف تکلیف.', 'error');
            return;
        }

        showToast('تکلیف با موفقیت حذف شد.', 'error');
        setTimeout(closeFullscreen, 300);
    }

    // ============================================
    // Auth & UI Logic
    // ============================================
    function updateUIForLogin(creatorCode) {
        currentCreator = creatorCode;
        loginButton.classList.add('hidden');
        addHomeworkMainButton.classList.remove('hidden');
        logoutButton.classList.remove('hidden');
        if (activeClone) renderClassContent(activeClone.className);
    }

    function updateUIForLogout() {
        currentCreator = null;
        loginButton.classList.remove('hidden');
        addHomeworkMainButton.classList.add('hidden');
        logoutButton.classList.add('hidden');
        if (activeClone) renderClassContent(activeClone.className);
    }

    loginButton.addEventListener('click', () => { showModal(loginModal); nameInput.focus(); });
    addHomeworkMainButton.addEventListener('click', () => {
        if (currentCreator) { resetHomeworkModal(); showModal(homeworkModal); } 
        else { showModal(loginModal); }
    });
    logoutButton.addEventListener('click', () => { 
        sessionStorage.removeItem('currentCreator'); 
        updateUIForLogout(); 
    });
    closeLogin.addEventListener('click', () => { hideModal(loginModal); });
    loginModal.addEventListener('click', (e) => { if (e.target === loginModal) hideModal(loginModal); });
    closeHomeworkModal.addEventListener('click', () => { hideModal(homeworkModal); });
    homeworkModal.addEventListener('click', (e) => { if (e.target === homeworkModal) hideModal(homeworkModal); });
   
    async function logNoAccess(failedCode) {
        await db.from('noaccess').insert([{ attempted_code: failedCode }]);
    }

    submitLogin.addEventListener('click', async () => {
        const code = nameInput.value.trim();
        if (!code) return;
        submitLogin.disabled = true;
        loginMessage.textContent = 'در حال بررسی کد...';
        loginMessage.className = 'text-sm mb-3 h-6 text-yellow-400';
        try {
            const { data, error } = await db.from('representatives').select('code').eq('code', code);
            if (error) throw error;
            if (!data || data.length === 0) {
                loginMessage.textContent = 'کد وارد شده اشتباه است.';
                loginMessage.className = 'text-sm mb-3 h-6 text-red-400';
                nameInput.value = '';
                await logNoAccess(code);
            } else {
                loginMessage.textContent = 'ورود موفقیت آمیز بود!';
                loginMessage.className = 'text-sm mb-3 h-6 text-green-400';
                sessionStorage.setItem('currentCreator', code);
                updateUIForLogin(code);
                setTimeout(() => {
                    hideModal(loginModal);
                    resetHomeworkModal();
                    showModal(homeworkModal);
                    nameInput.value = '';
                    loginMessage.textContent = '';
                }, 1000);
            }
        } catch (error) {
            loginMessage.textContent = 'خطا در ارتباط با دیتابیس.';
            loginMessage.className = 'text-sm mb-3 h-6 text-red-400';
            await logNoAccess(code);
        } finally {
            submitLogin.disabled = false;
        }
    });

    // ============================================
    // Homework Panel Logic
    // ============================================
    function resetHomeworkModal() {
        homeworkTitle.textContent = 'افزودن تکلیف جدید';
        addHomeworkButton.textContent = 'ثبت';
        homeworkIdInput.value = '';
        classSelect.value = '';
        homeworkDate.value = '';
        homeworkDueDate.value = '';
        homeworkDetails.value = '';
        homeworkTypeInput.value = 'homework';
        updateTypeButtons();
        validateHomeworkForm();
    }
   
    function updateTypeButtons() {
        const currentType = homeworkTypeInput.value;
        dueDateLabel.textContent = currentType === 'exam' ? 'تاریخ امتحان' : 'مهلت تحویل';
        homeworkDueDate.placeholder = currentType === 'exam' ? 'مثلا: شنبه ۱۴۰۴/۰۷/۱۲ زنگ سوم' : 'مثلا: تا جلسه آینده فیزیک';
        typeHomeworkBtn.classList.remove('bg-blue-500', 'text-white', 'ring-2', 'ring-blue-500');
        typeHomeworkBtn.classList.add('text-gray-300');
        typeExamBtn.classList.remove('bg-red-500', 'text-white', 'ring-2', 'ring-red-500');
        typeExamBtn.classList.add('text-gray-300');
        if(currentType === 'exam') {
            typeExamBtn.classList.add('bg-red-500', 'text-white', 'ring-2', 'ring-red-500');
            typeExamBtn.classList.remove('text-gray-300');
        } else {
            typeHomeworkBtn.classList.add('bg-blue-500', 'text-white', 'ring-2', 'ring-blue-500');
            typeHomeworkBtn.classList.remove('text-gray-300');
        }
    }

    function validateHomeworkForm() {
        const isClassSelected = classSelect.value !== '';
        const isDateEntered = homeworkDate.value.trim() !== '';
        const isDueDateEntered = homeworkDueDate.value.trim() !== '';
        const isDetailsEntered = homeworkDetails.value.trim() !== '';
        addHomeworkButton.disabled = !(isClassSelected && isDateEntered && isDueDateEntered && isDetailsEntered);
    }
    [classSelect, homeworkDate, homeworkDueDate, homeworkDetails].forEach(el => el.addEventListener('input', validateHomeworkForm));
    [typeHomeworkBtn, typeExamBtn].forEach(btn => {
        btn.addEventListener('click', () => {
            homeworkTypeInput.value = btn.dataset.type;
            updateTypeButtons();
        });
    });

    addHomeworkButton.addEventListener('click', async () => {
        if (!currentCreator || addHomeworkButton.disabled) return;
        addHomeworkButton.disabled = true;
        addHomeworkButton.textContent = 'در حال ذخیره...';
        const isEditing = homeworkIdInput.value !== '';
        const homeworkData = {
            classname: classSelect.value, date: homeworkDate.value.trim(),
            due_date_text: homeworkDueDate.value.trim(), homework: homeworkDetails.value.trim(),
            creator: currentCreator, is_exam: homeworkTypeInput.value === 'exam',
            is_edited: isEditing
        };
       
        if (!isEditing) {
            homeworkData.created_at = new Date().toISOString();
        }

        try {
            let result = isEditing ? await db.from('homeworks').update(homeworkData).eq('id', homeworkIdInput.value) : await db.from('homeworks').insert([homeworkData]);
            if (result.error) throw result.error;
           
            hideModal(homeworkModal);
            resetHomeworkModal();

            if (isEditing) {
                showToast('تکلیف با موفقیت ویرایش شد.');
                setTimeout(closeFullscreen, 300);
            } else {
                showToast('تکلیف جدید با موفقیت ثبت شد.');
                await db.from('announcements').insert([{ message: `${homeworkData.is_exam ? 'امتحان' : 'تکلیف'} جدیدی برای کلاس ${homeworkData.classname} ثبت شد.`, created_at: new Date().toISOString() }]);
            }

        } catch (e) {
            showToast('خطا در ذخیره سازی اطلاعات.', 'error');
        } finally {
            addHomeworkButton.disabled = false;
            addHomeworkButton.textContent = isEditing ? 'ذخیره تغییرات' : 'ثبت';
            validateHomeworkForm();
        }
    });

    // ============================================
    // Real-time Announcements & Presence
    // ============================================
    async function fetchAndRenderAnnouncements() {
        const { data, error } = await db.from('announcements').select('*').order('created_at', { ascending: false }).limit(10);
        if (error) { console.error("Error fetching announcements:", error); return; }
        if (!data || data.length === 0) { announcementsList.innerHTML = `<p style="color:var(--muted)">هنوز اعلانی ثبت نشده است.</p>`; return; }
        let announcementsHTML = '';
        const formatter = new Intl.DateTimeFormat('fa-IR', { weekday: 'long', hour: '2-digit', minute: '2-digit' });
        data.forEach(announcement => {
            const timeString = formatter.format(new Date(announcement.created_at));
            announcementsHTML += `<div class="p-3 rounded-md flex justify-between items-center" style="background-color: var(--card);"><span>${announcement.message}</span><span class="text-xs" style="color:var(--muted);">${timeString}</span></div>`;
        });
        announcementsList.innerHTML = announcementsHTML;
    }

    function listenForAnnouncements() {
        db.channel('public:announcements').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'announcements' }, () => fetchAndRenderAnnouncements()).subscribe();
    }
   
    function initializePresence() {
        const channel = db.channel('online-users', { config: { presence: { key: `user-${Math.random().toString(36).substring(7)}` } } });
        channel.on('presence', { event: 'sync' }, () => {
            onlineCountSpan.textContent = Object.keys(channel.presenceState()).length;
        });
        channel.subscribe(async (status) => {
            if (status === 'SUBSCRIBED') await channel.track({ online_at: new Date().toISOString() });
        });
    }

    // ============================================
    // Support Logic
    // ============================================
    async function handleSupportSubmit() {
        const message = supportDetails.value.trim();
        if (!message || submitSupport.disabled) return;

        submitSupport.disabled = true;
        submitSupport.textContent = 'در حال ارسال...';

        try {
            const { error } = await db.from('support_tickets').insert([{ message: message }]);
            if (error) throw error;

            supportFormView.classList.add('hidden');
            supportSuccessView.classList.remove('hidden');

            setTimeout(() => {
                hideModal(supportModal);
                setTimeout(() => {
                    supportFormView.classList.remove('hidden');
                    supportSuccessView.classList.add('hidden');
                    supportDetails.value = '';
                    submitSupport.disabled = false;
                    submitSupport.textContent = 'ارسال پیام';
                }, 500);
            }, 3000);

        } catch (e) {
            console.error("Error submitting support ticket:", e);
            showToast('خطا در ارسال پیام. لطفا دوباره تلاش کنید.', 'error');
            submitSupport.disabled = false;
            submitSupport.textContent = 'ارسال پیام';
        }
    }


    // ============================================
    // Initialization
    // ============================================
    function init() {
        createBlocks();
        createParticles();
        fetchAndRenderAnnouncements();
        listenForAnnouncements();
        initializePresence();
       
        const initialTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(initialTheme);
        themeToggle.addEventListener('click', () => applyTheme(document.body.dataset.theme === 'dark' ? 'light' : 'dark'));

        const savedCreator = sessionStorage.getItem('currentCreator');
        if (savedCreator) {
            updateUIForLogin(savedCreator);
        }

        classNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name; option.textContent = `کلاس ${name}`;
            classSelect.appendChild(option);
        });

        supportFab.addEventListener('click', () => showModal(supportModal));
        closeSupportModal.addEventListener('click', () => hideModal(supportModal));
        supportModal.addEventListener('click', (e) => { if (e.target === supportModal) hideModal(supportModal); });
        submitSupport.addEventListener('click', handleSupportSubmit);

        // --- New Clock/Date Listeners ---
        updateClock();
        setInterval(updateClock, 1000);

        timeButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const isHidden = datePopover.classList.toggle('hidden');
            if (!isHidden) {
                fetchAndRenderPopoverContent();
            }
        });
        
        document.addEventListener('click', (e) => {
            if (!document.getElementById('time-header-container').contains(e.target)) {
                datePopover.classList.add('hidden');
            }
        });
    }
   
    window.addEventListener('resize', createParticles);
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (loginModal.classList.contains('visible')) hideModal(loginModal);
            else if (homeworkModal.classList.contains('visible')) hideModal(homeworkModal);
            else if (supportModal.classList.contains('visible')) hideModal(supportModal);
            else if (datePopover && !datePopover.classList.contains('hidden')) datePopover.classList.add('hidden');
            else if (activeClone) closeFullscreen();
        }
    });
   
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
